#!/usr/bin/env zsh
source ${0:A:h}/../../deploy

source ./aliases.zsh

# Only for macOS
[[ $(_os) != macos ]] && exit

brew_deps=(
  karabiner-elements
)

link() {
  mkdir -p "$KARABINER_CONFIG_DIR"
  mklink json/* $KARABINER_CONFIG_DIR
  echo-info "Profile names"
  karabiner --list-profile-names
}

install() {
  brew install "${brew_deps[@]}"
  echo-info "Node.js $(<.node-version) is not installed. It's only needed if you want to regenerate the Karabiner config from source files (for development or customization)."
  update
}

update() {
  if has_exact_node_version; then
    build
  fi
  link
}

clean() {
  rm -rfv "$KARABINER_CONFIG_DIR"
}

build() {
  if ! _is_callable npm; then
    echo-fail "npm not found. Aborting build."
    exit 1
  fi
  npm run build

  # Validate complex modifications
  echo-info "Check Complex Modifications"
  if ! karabiner --lint-complex-modifications json/assets/complex_modifications/*; then
    echo-fail "Invalid Complex Modifications"
    exit 1
  fi
}

init "$@"
